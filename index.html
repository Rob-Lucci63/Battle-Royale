<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OnePiece 2.5D Simplified</title>
<style>
  body,html{margin:0;padding:0;height:100%;background:#07111b;overflow:hidden;}
  canvas{display:block;}
  #joystick{position:absolute;left:20px;bottom:100px;width:96px;height:96px;background:rgba(255,255,255,0.05);border-radius:50%;display:flex;justify-content:center;align-items:center;touch-action:none;z-index:10;}
  #knob{width:40px;height:40px;background:rgba(255,255,255,0.1);border-radius:50%;touch-action:none;}
  .btn{position:absolute;right:20px;bottom:120px;width:60px;height:40px;background:rgba(255,255,255,0.08);border-radius:8px;text-align:center;line-height:40px;color:#fff;font-weight:bold;user-select:none;touch-action:none;}
  #attackC{bottom:60px;}
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="joystick"><div id="knob"></div></div>
<div class="btn" id="attackL">لوفی</div>
<div class="btn" id="attackC">کاکو</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
<script>
const canvas = document.getElementById('gameCanvas');
const renderer = new THREE.WebGLRenderer({canvas,antialias:false});
renderer.setSize(window.innerWidth,window.innerHeight);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x07111b);

const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0,6,8);
camera.lookAt(0,0,0);

/* زمین ساده */
const ground = new THREE.Mesh(new THREE.PlaneGeometry(40,40), new THREE.MeshBasicMaterial({color:0x123f2c}));
ground.rotation.x = -Math.PI/2;
scene.add(ground);

/* بازیکن ساده */
function makePlayer(color){
  const g = new THREE.Group();
  const body = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.4,1), new THREE.MeshBasicMaterial({color}));
  body.position.y=0.5;
  g.add(body);
  return g;
}
const player = makePlayer(0xff6b6b);
scene.add(player);

/* حرکت */
const input={x:0,y:0,attackL:false,attackC:false};
let velocity=new THREE.Vector3();

/* جوی‌استیک */
const joystick=document.getElementById('joystick');
const knob=document.getElementById('knob');
let active=false,center={x:0,y:0};

joystick.addEventListener('touchstart',e=>{
  e.preventDefault();
  active=true;
  const t=e.touches[0];
  const rect=joystick.getBoundingClientRect();
  center.x=rect.left+rect.width/2;
  center.y=rect.top+rect.height/2;
  updateJoystick(t.clientX,t.clientY);
},{passive:false});

joystick.addEventListener('touchmove',e=>{
  if(!active) return;
  e.preventDefault();
  const t=e.touches[0];
  updateJoystick(t.clientX,t.clientY);
},{passive:false});

joystick.addEventListener('touchend',e=>{
  e.preventDefault();
  active=false;
  input.x=0;input.y=0;
  knob.style.transform='translate(0px,0px)';
});

function updateJoystick(cx,cy){
  const dx=cx-center.x;
  const dy=cy-center.y;
  const max=36;
  let nx=dx,ny=dy;
  const dist=Math.sqrt(dx*dx+dy*dy);
  if(dist>max){ nx=dx/dist*max; ny=dy/dist*max; }
  input.x=nx/max;
  input.y=-ny/max;
  knob.style.transform=`translate(${nx}px,${ny}px)`;
}

/* دکمه حمله */
document.getElementById('attackL').addEventListener('touchstart',()=>input.attackL=true);
document.getElementById('attackL').addEventListener('touchend',()=>input.attackL=false);
document.getElementById('attackC').addEventListener('touchstart',()=>input.attackC=true);
document.getElementById('attackC').addEventListener('touchend',()=>input.attackC=false);

/* حلقه بازی */
function animate(){
  requestAnimationFrame(animate);
  // حرکت
  const speed=5;
  velocity.lerp(new THREE.Vector3(input.x*speed,0,input.y*speed),0.2);
  player.position.x+=velocity.x*0.016;
  player.position.z+=velocity.z*0.016;
  player.rotation.y=Math.atan2(velocity.x,-velocity.z);

  renderer.render(scene,camera);
}
animate();

/* resize */
window.addEventListener('resize',()=>{
  renderer.setSize(window.innerWidth,window.innerHeight);
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
});
</script>
</body>
</html>