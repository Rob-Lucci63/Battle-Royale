<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Pixel Battle Royale</title>
<style>
  body { margin:0; overflow:hidden; background:#222; }
  canvas { display:block; background:#333; }
  .joystick {
    position: fixed;
    width: 80px; height: 80px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    touch-action: none;
  }
  #menu {
    position: absolute;
    top:0; left:0;
    width: 100%; height: 100%;
    background: #111;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    font-family: sans-serif;
  }
  button {
    margin: 5px;
    padding: 10px 20px;
    font-size: 20px;
    background: #444;
    color: white;
    border: none;
    cursor: pointer;
  }
  h1 { margin-bottom: 20px; }
</style>
</head>
<body>

<div id="menu">
  <h1>ساخته شده توسط Rob Lucci</h1>
  <h2>انتخاب مرحله</h2>
  <div id="levels"></div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let isMobile = /Mobi|Android/i.test(navigator.userAgent);
let player, bots, walls, bullets, botBullets;
let keys = {};
let moveVector = {x:0,y:0}, aimVector = {x:0,y:0};
let levelIndex = 0;

const levelsData = [
  { walls:[{x:300,y:300,w:150,h:20}], botCount:2 },
  { walls:[{x:200,y:150,w:200,h:20},{x:500,y:400,w:20,h:150}], botCount:3 },
  { walls:[{x:100,y:250,w:300,h:20},{x:400,y:100,w:20,h:200}], botCount:4 },
  { walls:[{x:250,y:350,w:250,h:20},{x:600,y:200,w:20,h:200}], botCount:5 },
  { walls:[{x:150,y:150,w:150,h:20},{x:450,y:450,w:200,h:20}], botCount:6 },
  { walls:[{x:200,y:200,w:250,h:20},{x:550,y:300,w:20,h:200}], botCount:7 }
];

document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

function createJoystick(left, top) {
    let joy = document.createElement("div");
    joy.className = "joystick";
    joy.style.left = left+"px";
    joy.style.top = top+"px";
    document.body.appendChild(joy);
    let origin = {x:0, y:0};
    let vector = {x:0, y:0};

    joy.addEventListener("touchstart", e => {
        origin.x = e.touches[0].clientX;
        origin.y = e.touches[0].clientY;
    });
    joy.addEventListener("touchmove", e => {
        let dx = e.touches[0].clientX - origin.x;
        let dy = e.touches[0].clientY - origin.y;
        let dist = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
        let angle = Math.atan2(dy, dx);
        vector.x = Math.cos(angle) * (dist/40);
        vector.y = Math.sin(angle) * (dist/40);
    });
    joy.addEventListener("touchend", () => { vector.x=0; vector.y=0; });
    return vector;
}

function startLevel(index){
    levelIndex = index;
    let level = levelsData[index];
    player = { x:100, y:100, size:20, speed:isMobile?2:3, hp:100 };
    bullets = [];
    botBullets = [];
    bots = [];
    walls = level.walls;
    for(let i=0;i<level.botCount;i++){
        bots.push({ x:Math.random()*canvas.width, y:Math.random()*canvas.height, size:20, speed:1.5, hp:50, shootTimer:0 });
    }
    document.getElementById("menu").style.display = "none";
}

if(isMobile){
    moveVector = createJoystick(30, window.innerHeight - 120);
    aimVector = createJoystick(window.innerWidth - 120, window.innerHeight - 120);
}

function update(){
    // player movement
    if(isMobile){
        player.x += moveVector.x * player.speed;
        player.y += moveVector.y * player.speed;
    } else {
        if(keys["w"]) player.y -= player.speed;
        if(keys["s"]) player.y += player.speed;
        if(keys["a"]) player.x -= player.speed;
        if(keys["d"]) player.x += player.speed;
    }

    // aim and shoot
    if(isMobile){
        if(Math.abs(aimVector.x) > 0.2 || Math.abs(aimVector.y) > 0.2){
            bullets.push({ x:player.x, y:player.y, dx:aimVector.x*5, dy:aimVector.y*5 });
        }
    } else {
        if(keys[" "]){ // space shoot
            let dx = 0, dy = 0;
            if(keys["ArrowUp"]) dy = -5;
            if(keys["ArrowDown"]) dy = 5;
            if(keys["ArrowLeft"]) dx = -5;
            if(keys["ArrowRight"]) dx = 5;
            if(dx || dy) bullets.push({ x:player.x, y:player.y, dx, dy });
        }
    }

    // bullets move
    bullets.forEach(b => { b.x += b.dx; b.y += b.dy; });
    botBullets.forEach(b => { b.x += b.dx; b.y += b.dy; });

    // bot movement + shooting
    bots.forEach(bot=>{
        let dx = player.x - bot.x;
        let dy = player.y - bot.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if(dist>0){
            bot.x += (dx/dist) * bot.speed;
            bot.y += (dy/dist) * bot.speed;
        }
        bot.shootTimer--;
        if(bot.shootTimer <= 0){
            botBullets.push({ x:bot.x, y:bot.y, dx:(dx/dist)*4, dy:(dy/dist)*4 });
            bot.shootTimer = 60;
        }
    });

    // collision: bullets hit bots
    bullets.forEach((b,bi)=>{
        bots.forEach(bot=>{
            if(Math.abs(b.x-bot.x)<15 && Math.abs(b.y-bot.y)<15){
                bot.hp -= 20;
                bullets.splice(bi,1);
            }
        });
    });

    // remove dead bots
    bots = bots.filter(bot=>bot.hp>0);

    // bot bullets hit player
    botBullets.forEach((b,bi)=>{
        if(Math.abs(b.x-player.x)<15 && Math.abs(b.y-player.y)<15){
            player.hp -= 10;
            botBullets.splice(bi,1);
        }
    });

    // win/lose
    if(player.hp <= 0){
        alert("باختی!");
        location.reload();
    }
    if(bots.length === 0){
        alert("مرحله رو بردی!");
        if(levelIndex < levelsData.length-1) startLevel(levelIndex+1);
        else alert("همه مراحل رو بردی!");
    }
}

function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // walls
    ctx.fillStyle = "gray";
    walls.forEach(w=>ctx.fillRect(w.x,w.y,w.w,w.h));
    // player
    ctx.fillStyle = "blue";
    ctx.fillRect(player.x, player.y, player.size, player.size);
    // bots
    ctx.fillStyle = "red";
    bots.forEach(bot=>ctx.fillRect(bot.x, bot.y, bot.size, bot.size));
    // bullets
    ctx.fillStyle = "yellow";
    bullets.forEach(b=>ctx.fillRect(b.x,b.y,5,5));
    ctx.fillStyle = "orange";
    botBullets.forEach(b=>ctx.fillRect(b.x,b.y,5,5));
    // hp bar
    ctx.fillStyle = "green";
    ctx.fillRect(10,10,player.hp*2,10);
}

function gameLoop(){
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

function initMenu(){
    let levelsDiv = document.getElementById("levels");
    levelsData.forEach((l,i)=>{
        let btn = document.createElement("button");
        btn.innerText = "مرحله " + (i+1);
        btn.onclick = ()=>startLevel(i);
        levelsDiv.appendChild(btn);
    });
}

initMenu();
gameLoop();
</script>
</body>
</html>